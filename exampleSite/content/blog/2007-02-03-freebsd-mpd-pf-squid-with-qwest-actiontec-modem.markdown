---
title: FreeBSD MPD PF Squid (with Qwest Actiontec Modem)
image: images/40.jpg
date: 2007-02-03 12:02:00.000000000 -07:00
---
<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://www.freebsd.org/"><img style="margin: 1px auto 10px; display: block; text-align: center; cursor: pointer; width: 200px;" src="/images/old/logo-full-thumb.png" alt="" border="0" /></a><br />If you understand the title, you truly are a geek....just like me.<br />Since I am an uber geekster of the computer variety, I like to setup firewalls, operating systems, and other related nerdly stuff.<br />So I thought I'd post my processes of setting up a Squid proxy server, a Packet Filter (PF) firewall using MPD for the PPPoE (mine is really PPPoA) connection through Qwest's Actiontec Modem on a FreeBSD (Unix) boxen.<br />Since there is no definitive or recent guide on how to do this, I thought I'd write up my findings.<br /><br />Well, how do I begin????  This is no where complete, just a mere guideline.  I wish I documented everything step by step, but it was/is an ongoing process.<br /><br />So, install FreeBSD on an old computer.  Just minimal so it can connect to the net.  You can find out how to install FreeBSD somewhere else.  It's the easiest OS I've ever installed (base system anyways).  Then it has also been the hardest with configuration, firewalls, other stuff, and junk.<br /><br />Once connected, update your system, ports, etc. while behind an existing firewall of some sort.<br /><br />Then:<br /><br /><span style="font-size:85%;"><span style="font-family:times new roman;">pkg_add -r mpd</span><br /><span style="font-family:times new roman;">pkg_add -r squid</span></span><br /><br />For the mpd and pf configuration I followed a lot of this tut here:<br /><a href="http://ezine.daemonnews.org/200406/mpd.html">http://ezine.daemonnews.org/200406/mpd.html</a><br /><br />Mind you, Qwest is my ISP, but the name really doesn't matter.  Instead of tonlinedsl, you could call it qwestdsl or the likes.<br /><br />Here is my mpd.conf file:<br /><br /><span style="font-size:85%;"><span style="font-family:times new roman;">default:<br />load tonlinedsl<br /><br />tonlinedsl:<br />new -i ng0 tonlinedsl PPPoE<br />set iface addrs x.x.x.x.<br />set iface route default<br />set iface disable on-demand<br />set iface idle 0<br />set bundle disable multilink<br />set bundle authname xxxxxx@xxxx.xxx<br />set link no acfcomp protocomp<br />set link disable pap chap<br />set link accept chap<br />set link mtu 1492<br />set link keep-alive 10 60<br />set ipcp yes vjcomp<br />set ipcp ranges 0.0.0.0/0 0.0.0.0/0<br />set iface up-script /usr/local/etc/mpd/mpd_dsl.linkup<br />open iface<br /></span></span><br />Here is my pf.conf file<br /><br /><span style="font-size:85%;"><span style="font-family:times new roman;">#Macros<br />ext_if="ng0"<br />int_if="xl0"<br />priv_nets="{x.x.x.x/24}"<br /><br />tcp_services="{53,113,3128}"<br />icmp_types="echoreq"<br /><br /><br /># hosts that can use this system as a gateway<br />table <allowhost> const {x.x.x.x/24}<br /><br />#options<br />set block-policy return<br />set loginterface $ext_if<br />set skip on {lo0,$int_if}<br /><br /># Clean up fragmented and abnormal packets, defeat NAT detection too<br /># max-mss is needed due to MPD's poor MSS handling<br />scrub in all<br />scrub out all random-id max-mss 1440<br /><br /># NAT section/Redirect<br />nat on $ext_if from $int_if:network to any -> ($ext_if)<br />rdr on $int_if proto tcp from any to ! ($int_if) port 21 -> 127.0.0.1 port 8021<br /><br /><br />#filter rules<br />block log all<br />block drop in quick on $ext_if from $priv_nets to any<br />block drop out quick on $ext_if from $ext_if to $priv_nets<br />pass in on $ext_if inet proto tcp from any to ($ext_if) port $tcp_services flag<br />s S/SA keep state<br />pass in on $ext_if inet proto tcp from port 20 to ($ext_if) user proxy flags S/<br />SA keep state<br />pass in inet proto icmp all icmp-type $icmp_types keep state<br />pass in on $int_if from $int_if:network to any keep state<br />pass out on $int_if from any to $int_if:network keep state<br /><br />#Other<br />pass out on $ext_if proto tcp all modulate state flags S/SA<br />pass out on $ext_if proto {udp,icmp} all keep state<br /></span></allowhost></span></span><br /><br /><span style=";font-family:times new roman;font-size:100%;"  >Then, I setup squid pretty much verbatim (other than the cache location, and local definable settings.) using this link:<br /><a href="http://www.bsdguides.org/guides/freebsd/networking/squid.php">http://www.bsdguides.org/guides/freebsd/networking/squid.php</a><br /><br />I won't post my squid.conf file since I just edited the original.  You may want to just make yours like the Guide above.<br /><br />On the Qwest modem, I changed it to "transparent bridge," turned off DHCP server, and tried to turn off NAT, but it wouldn't let me.  I may need to mess with it some more.<br /><span style=";font-family:times new roman;font-size:100%;"  ><br />Here is my rc.conf file:</span><br /><br /><span style="font-size:85%;"><span style="font-family:times new roman;"># Enable network daemons for user convenience.<br /># Please make all changes to this file, not to /etc/defaults/rc.conf.<br /># This file now contains just the overrides from /etc/defaults/rc.conf.<br />hostname="xxxx.xxxx.com"<br /><br />sshd_enable="YES"<br />usbd_enable="YES"<br />mpd_enable="YES"<br /><br /><br />natd_enable="YES" #I don't really know if this is necessary<br />natd_interface="fxp0" #or this<br /><br />#PF estuff<br />pf_enable="YES"<br />pf_flags="-d"<br />pflog_enable="YES"<br />pflog_logfile="/var/log/pflog"<br />pflog_flags=""<br /><br />gateway_enable="YES"<br /><br /># -- sysinstall generated deltas -- # Thu Jan 18 20:32:48 2007<br />ifconfig_xl0="inet x.x.x.x  netmask x.x.x.x"<br /><br />squid_enable="YES"<br /></span></span><br />I have pf reloaded in a script due to what the mpd/pf guide said.<br /><br />Now I just need to modify my pf.conf to route every http(s) request over the squid proxy.  The proxy works, it just also allows the LAN to get out directly as well.  I also need to figure out how to get ftp to work either/with the proxy and/or PF.<br /><br />One of the hardest things for my mind to grasp is what is your external interface?  It seems to be ng0, which is the interface that mpd creates.  But the physical card is fxp0.<br /><br />After much tinkering and messing around, I got this to work for me.  Some people may ask why?  I say....mmmmmmmmmmmmBecauseIcanmmmmmmmm.  And next to setup is perhaps squidguard to block the nasty sites from the kid.<br /><br />If you have any suggestions, enhancements, requests, please post here!<br /><br /><br /><br />Update:  I got squidGuard working on the system....!!!! The main thing I learned is to change ownership and group on everyting to squid:squid!
